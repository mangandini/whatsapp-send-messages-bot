## Deployment

This project offers two ways to define its processes for deployment platforms:

1.  **`ecosystem.config.js`:** Uses the PM2 process manager. This is recommended for robustness (auto-restarts, monitoring) and is used in the detailed Coolify instructions.
2.  **`Procfile`:** A simpler format often used by Heroku-like platforms and standard buildpacks (like Nixpacks or Cloud Native Buildpacks). It defines the `web` and `worker` processes directly.

### Deployment with Coolify (Using `ecosystem.config.js`)

Coolify integrates well with PM2. Follow these steps for optimal setup:

1.  **Source:** Point Coolify to your Git repository.
2.  **Build Pack:** Select the Nixpacks builder (which can also understand `Procfile`, but we'll use PM2 here for more control).
3.  **Start Command:** Crucially, set the **Start Command** in your Coolify Application settings to:
    ```
    pm2-runtime ecosystem.config.js
    ```
    *   This command tells PM2 (specifically its container-friendly version) to start *both* the `web` and `worker` processes defined in `ecosystem.config.js`. Coolify uses the `web` process defined here for HTTP routing.
4.  **Persistent Storage:** Configure persistent storage volumes in Coolify for:
    *   `/app/db` (for the `database.sqlite` file)
    *   `/app/.wwebjs_auth` (for the WhatsApp session files)
5.  **Environment Variables:** Add all necessary environment variables (`PORT`, `DATABASE_PATH`, `CORS_ORIGIN`, etc.) in your Coolify service settings. Ensure `DATABASE_PATH` points to the path *inside* the container (e.g., `/app/db/database.sqlite`). `PORT` will be managed by Coolify based on the `web` process.
6.  **Domain & HTTPS:** Configure your domain name in the Coolify service settings for the `web` application. Coolify will handle the reverse proxy and SSL certificate. Ensure `CORS_ORIGIN` matches your configured domain (e.g., `https://your-bot-domain.com`).
7.  **QR Code Scanning & Device Linking:**
    *   After deployment, monitor the logs for the `worker` service in Coolify.
    *   When WhatsApp authentication is needed, the `worker` will print a QR code directly in the logs.
    *   **Issue:** Sometimes, the QR code rendered in the terminal logs might be difficult to scan due to formatting or font issues.
    *   **Solution:** Immediately after the visual QR code, the logs will also print the raw QR code string data, like this:
        ```
        --------------------------------------------------
        ⚠️ If the QR above is not scannable, copy the following string and create a QR code with it:
        [A long string starting with '1@...']
        --------------------------------------------------
        ```
    *   Copy the entire long string that appears between the dashed lines.
    *   Paste this string into an online QR code generator or to the terminal (search for "text to QR code generator").
    *   Scan the QR code image generated by the online tool using your WhatsApp mobile app (Settings > Linked Devices > Link a Device).

### Deployment with PM2 (Generic / Non-Coolify)

If you are deploying to a VPS, container, or another environment where you manage PM2 yourself:

1.  **Install Node.js and npm.**
2.  **Clone the repository and install dependencies (`npm install`).**
3.  **Install PM2 globally:** `npm install pm2 -g` (or use `npx pm2` without global installation).
4.  **Configure Environment Variables:** Set up your `.env` file or configure environment variables directly in your server environment.
5.  **Configure Persistent Storage:** If deploying in an environment where the filesystem is not persistent by default (like containers), ensure you mount persistent volumes for:
    *   `/app/db` (for the database)
    *   `/app/.wwebjs_auth` (for the WhatsApp session)
6.  **Start the application:** Navigate to the project directory in your terminal and run:
    ```bash
    pm2 start ecosystem.config.js
    ```
    *   This command reads `ecosystem.config.js` and starts *both* the `web` and `worker` processes under PM2's management.
    *   Use `pm2 list` to see status, `pm2 logs` to view logs, `pm2 stop all`, `pm2 restart all`, etc.
    *   If running inside a **Docker container**, prefer `pm2-runtime ecosystem.config.js` as your container's `CMD` or `ENTRYPOINT`. This keeps PM2 running in the foreground, which is necessary for containers.
7.  **QR Code:** Monitor the PM2 logs (`pm2 logs worker`) for the QR code when needed. Follow the same steps as in the Coolify guide to scan it.
8.  **Web Server Access:** Ensure the port defined for the `web` process (via `PORT` environment variable or default) is accessible, possibly setting up a reverse proxy (like Nginx or Caddy) to handle external traffic and HTTPS.

### Deployment with Procfile (e.g., Heroku, Dokku, some Buildpacks)

If your deployment platform automatically detects and uses `Procfile`:

1.  **Platform Detection:** Most platforms that support `Procfile` (like Heroku, Dokku, or those using standard Cloud Native Buildpacks / Nixpacks configured to use it) will automatically detect the file during the build or deployment process.
2.  **Process Execution:** The platform will typically start one instance of each process type defined in the `Procfile` (`web` and `worker` in this case).
3.  **Web Routing:** The platform usually routes external HTTP/S traffic automatically to the process designated as `web`.
4.  **Configuration:** You generally **do not need to specify a "Start Command"** manually if the platform uses the `Procfile`. Configure Environment Variables and any necessary Persistent Storage through your platform's interface.
    *   **Ensure you configure Persistent Storage (Volumes) for:**
        *   `/app/db` (for the database)
        *   `/app/.wwebjs_auth` (for the WhatsApp session)
5.  **QR Code:** You will need to access the logs for the `worker` process through your platform's logging interface to find and scan the QR code when needed.
